+++
title = "iOS push notification"
date = 2014-09-30T18:59:00Z
updated = 2014-09-30T18:59:25Z
tags = ["Golang", "iOS"]
blogimport = true 
[author]
	name = "TerryH"
	uri = "https://www.blogger.com/profile/00198432946574471177"
+++

首先您必須到 https://developer.apple.com/ 去新增一個 App，一般就是你要用 push notification 的應用程式<br /><br />設定好名字，還有 ID ，記得要把 Push Notifications 的服務打勾<br /><br />我這裡說明就用中文，因為英文的說明有一堆了<br /><br />接下來就可以打開您的 Mac / 應用程式 / 工具程式 / 鑰匙圈存取<br /><br />我們選憑證輔助程式，從憑證授權要求憑證<br /><br /><a href="http://2.bp.blogspot.com/-DltEQBGZMJI/VCp9t0WPsBI/AAAAAAAABwE/zJrsqCjndZ0/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.27.01.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-DltEQBGZMJI/VCp9t0WPsBI/AAAAAAAABwE/zJrsqCjndZ0/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.27.01.png" /></a><br /><br /><br />把他存下來，我舉的例子就叫 PushMsg ，把檔名改成 PushMsg 所以你會得到 PushMsg.certSigningRequest 這一個 CSR ，待會要到 apple 網站上面產生憑證<br /><br /><a href="http://3.bp.blogspot.com/-GWJqvDvhOG8/VCp9uT3m0sI/AAAAAAAABwQ/4uXVaux1H9I/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.28.09.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-GWJqvDvhOG8/VCp9uT3m0sI/AAAAAAAABwQ/4uXVaux1H9I/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.28.09.png" /></a><br /><br />產生後，到鑰匙圈存取 應用程式，選鑰匙的地方，你會看到有 PushMsg 的公鑰和密鑰，點選專用密鑰，按下滑鼠右鍵輸出憑證，輸出成 PushMsg.p12 待會用<br /><br /><a href="http://3.bp.blogspot.com/-DUBig5_Bkl8/VCp9vFoH96I/AAAAAAAABwM/i__PPNvwKXA/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.28.33.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-DUBig5_Bkl8/VCp9vFoH96I/AAAAAAAABwM/i__PPNvwKXA/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.28.33.png" /></a><br /><br /><a href="http://1.bp.blogspot.com/-fpBrCNj9824/VCp9vpdCt-I/AAAAAAAABwc/KgMtZc-RFUc/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.29.30.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-fpBrCNj9824/VCp9vpdCt-I/AAAAAAAABwc/KgMtZc-RFUc/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.29.30.png" /></a><br /><br /><a href="http://4.bp.blogspot.com/-nkn5D5oY1fY/VCp9wSNGWtI/AAAAAAAABwk/xF52rlIm5vk/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.30.04.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-nkn5D5oY1fY/VCp9wSNGWtI/AAAAAAAABwk/xF52rlIm5vk/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.30.04.png" /></a><br /><br /><br /><a href="http://4.bp.blogspot.com/-AU_Mzk8QN70/VCp9xFnF3SI/AAAAAAAABwo/gugWparcFaw/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.30.12.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-AU_Mzk8QN70/VCp9xFnF3SI/AAAAAAAABwo/gugWparcFaw/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.30.12.png" /></a><br /><br />這時候，請用剛剛的 PushMsg.certSigningRequest 到 Apple 開發者網站的 App 設定 notification 的地方去產生憑證，可以下載後，<br /><br />開發模式，你會得到 aps_development.cer ，實際部署模式，請依此類推 <br /><br /><a href="http://4.bp.blogspot.com/-L8vm5f_rGms/VCp9xlj4vII/AAAAAAAABws/8Kcpixc2ypk/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.52.19.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-L8vm5f_rGms/VCp9xlj4vII/AAAAAAAABws/8Kcpixc2ypk/s640/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-09-30%2B%E4%B8%8B%E5%8D%885.52.19.png" /></a><br /><br />我們現在有 PushMsg.certSigningRequest , PushMsg.p12 , 還有 aps_development.cer 接下來，我們來產生，Server 端程式需要的憑證格式<br /><br />這裡的程式，我們用 Golang 的範例，其他用 Python , Node.js 或是其他語言的朋友請依此類推<br /><br />產生 cert.pem<br /><br /><pre><code class="language-markup"><br />openssl x509 -in aps_development.cer -inform der -out cert.pem<br /></code></pre><br />產生 key.pem 由於我很懶，key.pem 不想加密碼，程式不想再判斷密碼部分，我用這樣，如果你要加 pass phrase 就不要加上 -nodes 即可<br /><pre><code class="language-markup"><br />openssl pkcs12 -in PushMsg.p12 -out key.pem -nodes<br /></code></pre><br />最後就是用 Apple 文件上面的 openssl 測試即可，沒有錯誤，就是 OK 了<br /><pre><code class="language-markup"><br />openssl s_client -connect gateway.sandbox.push.apple.com:2195 -cert cert.pem -key key.pem <br /></code></pre><br />最後附上 golang 的測試程式，實際上已經有現成的 library 可以用 <a href="https://github.com/anachronistic/apns">https://github.com/anachronistic/apns</a><br /><br />只有連線的測試，有用 openssl 測試就可了，直接執行沒有錯誤，就是連線沒有問題了，送訊息可以直接用上面的 library <br /><br /><pre><code class="language-markup"><br />package main<br /><br />import (<br /> "crypto/tls"<br /> "fmt"<br /> "net"<br /> "os"<br />)<br /><br />func main() {<br /><br /> // load <br /> cert, err := tls.LoadX509KeyPair("./cert.pem", "./key.pem")<br /> if err != nil {<br />  fmt.Println("key error: ", err)<br />  os.Exit(1)<br /> }<br /> conf := &tls.Config{<br />  Certificates: []tls.Certificate{cert},<br />  ServerName:   "gateway.sandbox.push.apple.com",<br /> }<br /><br /> // connect to APPLE <br /> conn, err := net.Dial("tcp", "gateway.sandbox.push.apple.com:2195")<br /><br /> if err != nil {<br />  fmt.Println("tcp error: ", err)<br />  os.Exit(1)<br /> }<br /><br /> tlsconn := tls.Client(conn, conf)<br /><br />        // be nice<br /> err = tlsconn.Handshake()<br /> if err != nil {<br />  fmt.Println("tls error: ", err)<br />  os.Exit(1)<br /> }<br /><br />}<br /><br /></code></pre><br /><br /><br />參考資料<br /><br /><a href="http://www.raywenderlich.com/32960/apple-push-notification-services-in-ios-6-tutorial-part-1">http://www.raywenderlich.com/32960/apple-push-notification-services-in-ios-6-tutorial-part-1</a><br /><br /><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html">https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html</a><br /><br /><a href="http://bravenewmethod.com/2011/02/25/apple-push-notifications-with-go-language/">http://bravenewmethod.com/2011/02/25/apple-push-notifications-with-go-language/</a><br />
