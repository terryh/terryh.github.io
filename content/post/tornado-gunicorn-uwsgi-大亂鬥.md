+++
title = "Tornado Gunicorn uWSGI 大亂鬥"
date = 2011-05-29T02:05:00Z
updated = 2011-09-30T07:45:25Z
tags = ["Python", "Tornado", "uWSGI", "Gunicorn", "WSGI", "Web"]
blogimport = true 
[author]
	name = "TerryH"
	uri = "https://www.blogger.com/profile/00198432946574471177"
+++

最近因為有個屬於幫忙性質的案子，這一個專案的主角，有一些堅持，所以也算讓我可以多用一些東西 XD<br /><br />在這一專案，我是屬於打工的角色，所以一般，主角決定了什麼，打工的做就對了，原本原型，是 <a href="https://www.djangoproject.com/">Django</a> 搭 MySQL 的專案，要改成 <a href="http://www.tornadoweb.org/">Tornado</a> 加 <a href="http://www.mongodb.org/">MongoDB</a> ， 但是，好歹多年前，也看過<br /><br />Nicholas Piël 的 WSGI Server 大亂鬥 <a href="http://nichol.as/benchmark-of-python-web-servers">http://nichol.as/benchmark-of-python-web-servers</a><br /><br />知道其實 Tornado 也沒有多佔便宜，但是口說無憑，當然秉持科學的精神(當然這樣也沒什麼科學)，利用一下，小寶寶午休時間，中年老爸，趕快來作一下， benchmark 來驗證一下，就不 post 詳細的數據啦，我只是給自己驗證的結果，所有的軟體，都是安裝最新穩定版，用 pip install 的方式，在 debian 上面測試，官方的文件是說 nginx 只要是大於等於 0.7.63 版，都有將 uWSGI 包含進去，所以不需要重新編譯安裝 nginx ， 想用新一點的人要自己再編譯 nginx ，測試用的工具是 Apache 的工具 ab -c 500 -n 2000 <br /><br />uWSGI 效能第一 (100%)，穩定，但是，設定的選項很多，對 Linux 沒有概念的，可能比較不會發揮，適合 Linux 熟的<br /><br />Tornado 效能第二 (93%)，回應時間，落差比較大，適合，喜歡自己打造東西的人<br /><br />Gunicorn 效能第三 (84%)，穩定，設定非常的簡單，回應時間穩定<br /><br /><br />百分比，只是，回應速度，在加權一點回應時間，測試的程式，就只是基本的 Hello World or Ping Pong 的方式，以上三個，都足以應付 production 的需求環境<br /><br /><br />測試條件<br /><br />uWSGI 基本上都是參考 Nicholas Piël 方式，不過有些系統的對應參數，必須先用 sysctl 調好，也要懂 -l 的數字一定要大於等於你的 concurrency 數，都是透過 nginx <br /><br />sysctl -w net.ipv4.tcp_keepalive_time=300<br />sysctl -w net.core.somaxconn=250000<br />sysctl -w net.ipv4.tcp_max_syn_backlog=2500<br />sysctl -w net.core.netdev_max_backlog=2500<br /><br /><br />uwsgi --gid www-data --uid www-data -z 30 -l 500 -L -M -s 127.0.0.1:3031 -p 4 --env DJANGO_SETTINGS_MODULE=bench.settings -w "django.core.handlers.wsgi:WSGIHandler()" # django app<br /><br />uwsgi --gid www-data --uid www-data -z 30 -l 500 -L -M -s 127.0.0.1:3031 -p 4 -pythonpath `pwd` -w myapp # 單純 wsgi app<br /><br /><br />Tornado 參考 Nicholas Piël 直接打，還有就是用 https://github.com/bdarnell/django-tornado-demo 的 testsite 測試<br /><br /><br />Gunicorn 直接用 gunicorn_django --worker=2 ，其實這樣對他有一點不公平，也應該直接接 wsgi app  才對，不過，他的設定最簡單，可以直接上，這就是他的好處<br /><br /><br />PS1: 專案的架構，一般都是見仁見智，很難有一定的評斷，但是連正式上線，都還沒有上線，就將原型完全換掉，也是一種神人級的豪賭，一種情形是，這些東西神人都可以自己生出來，所以不在乎原型，一種是，神人不喜歡，別人寫得東西，喜歡自己來，一般決定一個專案的架構的時候，第一點，一定是，時間，人力，還有成員的熟悉度，絕不是，盲目的追求效能，或是熱門的話提，要跨入 nosql 之前，先看看自己作過幾個大型的 SQL 專案，能發揮到什麼程度，可以先由一些小型的專案，驗證熟悉<br /><br />PS2: 這個原型，是我看過非常乾淨的 Django project 不管是自身的架構或是重用別人的部份，都算是非常的漂亮 ( 原作者還呼隴我說寫的很丑很髒 )<br /><br /><br />PS3: 其實用 Django 外，Python 不像 Ruby 那樣，選擇不多，相反地，我的媽壓，還真不好選， <a href="http://wiki.python.org/moin/WebFrameworks">http://wiki.python.org/moin/WebFrameworks</a> ，不同專案有不同需求，找自己愛用的吧，玩得開心最重要，喜歡套件 AP 多，可以直接上，就 Django ，喜歡自己打造，選擇有一大票
